#!/bin/sh

if [ "$ALLOW_WORKFLOW_PUSH" = "1" ]; then
  exit 0
fi

zero_sha="0000000000000000000000000000000000000000"

while read local_ref local_sha remote_ref remote_sha
do
  if [ "$local_sha" = "$zero_sha" ]; then
    continue
  fi

  if [ "$remote_sha" = "$zero_sha" ]; then
    range="$local_sha"
  else
    range="$remote_sha..$local_sha"
  fi

  if git diff --name-only "$range" | grep -q '^\.github/workflows/'; then
    echo ""
    echo "❌ Push bloqué localement: changement détecté dans .github/workflows/*"
    echo "GitHub rejettera ce push avec ton auth actuelle (scope workflow manquant)."
    echo ""
    echo "Options:"
    echo "  - retire le workflow du commit"
    echo "  - utilise des credentials avec scope workflow"
    echo "  - override ponctuel: ALLOW_WORKFLOW_PUSH=1 git push"
    echo ""
    exit 1
  fi
done

exit 0